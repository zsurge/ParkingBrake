C51 COMPILER V9.00   WG34                                                                  03/19/2019 15:19:42 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE WG34
OBJECT MODULE PLACED IN ..\HEX\Wg34.obj
COMPILER INVOKED BY: c:\Keil\C51\BIN\C51.EXE ..\SCR\Wg34.c BROWSE INCDIR(..\INC) DEBUG OBJECTEXTEND PRINT(.\Wg34.lst) TA
                    -BS(2) OBJECT(..\HEX\Wg34.obj)

line level    source

   1          #include "Wg34.h"
   2          
   3          void Delay100us(u8 us)       //@11.0592MHz
   4          {
   5   1          unsigned char i, j;
   6   1      
   7   1          do
   8   1          {
   9   2              _nop_();
  10   2              _nop_();
  11   2              i = 2;
  12   2              j = 15;
  13   2              do
  14   2              {
  15   3                  while (--j);
  16   3              } while (--i);
  17   2          }
  18   1          while (--us);
  19   1      }
  20          
  21          void delay_ms(u8 ms)    
  22          {  
  23   1          u16 i;  
  24   1          do{  
  25   2              i=MAIN_Fosc/9600;  
  26   2              while(--i);     //96T per loop  
  27   2          }while(--ms);       //--ms  ms=ms-1  
  28   1      }  
  29          
  30          
  31          #if WIEGANDPROTOCAL == 34
              void Send_Weigand34(unsigned char *str)
              {
                  unsigned char one_num = 0;
                  unsigned char even = 0;
                  unsigned char odd = 0;
                  unsigned char check_temp,i;
              
                  check_temp = *str;
              
                  for(i = 0;i < 8;i++)
                  {
              
                      if(check_temp & 0x01)
                          one_num++;
              
                      check_temp >>= 1;
                  }
              
                  check_temp = *(str + 1);
                  for(i = 0;i < 8;i++)
                  {
              
                      if(check_temp & 0x01)
C51 COMPILER V9.00   WG34                                                                  03/19/2019 15:19:42 PAGE 2   

                          one_num++;
              
                          check_temp >>= 1;
                      }
              
                  if(one_num % 2 )
                      even = 1;
                  else
                      even = 0;
              
                  one_num = 0;
                  check_temp = *(str + 2);
              
                  for(i = 0;i < 8;i++)
                  {
                      if(check_temp & 0x01)
                          one_num++;
                      check_temp >>= 1;
                  }
              
                  check_temp = *(str + 3);
              
                  for(i = 0;i < 8;i++)
                  {
                      if(check_temp & 0x01)
                          one_num++;
                      
                      check_temp >>= 1;
                  }
              
                  if(one_num % 2 )
                      odd = 0;
                  else
                      odd = 1;
              
                  one_num = 0;
              
                  WG_DATA0 = 1;
                  WG_DATA1 = 1;
              
                  delay_ms(1);
                  
                  if(even)
                  {
              
                      WG_DATA1 = 0; /*偶校验位为1*/
                      Delay100us(2);
                      WG_DATA1 = 1;
                  }
                  else
              
                  {
                      WG_DATA0 = 0; /*偶校验位为0*/
                      Delay100us(2);
                      WG_DATA0 = 1;
                  }
              
                  delay_ms(1); /*延时1ms*/
              
                  for(i = 0;i < 32;i++)
                  {
                      WG_DATA0 = 1;
C51 COMPILER V9.00   WG34                                                                  03/19/2019 15:19:42 PAGE 3   

                      WG_DATA1 = 1;
              
                      if(str[0] & 0x80)
                      {
                          WG_DATA1 = 0;
                          Delay100us(2);
                          WG_DATA1 = 1;
                      }
                      else
                      {
                          WG_DATA0 = 0;
                          Delay100us(2);
                          WG_DATA0 = 1;
                      }
              
                      (*(long*)&str[0]) <<= 1;
              
                      delay_ms(1); /*延时1ms*/
                  }
              
                  WG_DATA0 = 1;
                  WG_DATA1 = 1;
              
                  if(odd)
                  {
                      WG_DATA1 = 0;
                      Delay100us(2);
                      WG_DATA1 = 1;
                  }
                  else
                  {
                      WG_DATA0 = 0;
                      Delay100us(2);
                      WG_DATA0 = 1;
                  }
              
                  delay_ms(1);
              }
              
              #else
 157          
 158          bit Even_Parity(unsigned char *DataBits)
 159          {
 160   1        unsigned char i,j;
 161   1        bit Bit_EP;
 162   1        for(i=0,j=0;i<12;i++)
 163   1        {
 164   2          if(DataBits[i]==0x01)
 165   2          {
 166   3            j++;
 167   3           }
 168   2        }
 169   1        if((j&0x01)==0x01)Bit_EP=1;
 170   1        else Bit_EP=0;
 171   1        return(Bit_EP);
 172   1      }
 173          
 174          
 175          bit Odd_Parity(unsigned char *DataBits)
 176          {
 177   1        bit Bit_OP;
 178   1        unsigned char i,j;
C51 COMPILER V9.00   WG34                                                                  03/19/2019 15:19:42 PAGE 4   

 179   1        for(i=0,j=0;i<12;i++)
 180   1        {
 181   2          if(DataBits[i]==0x01)
 182   2          {
 183   3            j++;
 184   3           }
 185   2        }
 186   1        if((j&0x01)==0x01)Bit_OP=0;
 187   1        else Bit_OP=1;
 188   1        return(Bit_OP);
 189   1      }
 190          
 191          void Send_Wiegand26(u8 fc,u16 cc)
 192           {
 193   1        u8 i = 0;
 194   1        u8 CardNo[26] = {0};
 195   1        //得到HID的低8位
 196   1        for(i=1;i<9;i++)
 197   1        {
 198   2         CardNo[i]=(fc&0x80)>>7;
 199   2         fc=fc<<1;
 200   2         }
 201   1        //得到16位机器号
 202   1        for(i=9;i<25;i++)
 203   1        {
 204   2              if((cc&0x8000)==0x8000)
 205   2                  CardNo[i]=0x01;
 206   2              else 
 207   2                  CardNo[i]=0x00;
 208   2              
 209   2              cc=cc<<1;
 210   2         }
 211   1        //偶校验位
 212   1        if((Even_Parity(&CardNo[1]))==1)
 213   1              CardNo[0]=0x01;
 214   1        else 
 215   1              CardNo[0]=0x00;
 216   1          
 217   1        //奇校验位
 218   1        if((Odd_Parity(&CardNo[13]))==1)
 219   1              CardNo[25]=0x01;
 220   1        else
 221   1            CardNo[25]=0x00;
 222   1          
 223   1        for( i=0;i<26;i++)
 224   1        {
 225   2           if(CardNo[i]==0x01)
 226   2           {
 227   3                WG_DATA1=0;
 228   3                Delay100us(1);
 229   3                WG_DATA1=1;
 230   3           }
 231   2           else
 232   2           {
 233   3                WG_DATA0=0;
 234   3                Delay100us(1);
 235   3                WG_DATA0=1;
 236   3           }
 237   2      
 238   2            delay_ms(1);
 239   2         }
 240   1        }
C51 COMPILER V9.00   WG34                                                                  03/19/2019 15:19:42 PAGE 5   

 241          
 242          #endif
 243          
 244          
 245          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    304    ----
   CONSTANT SIZE    =     26    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      36
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
