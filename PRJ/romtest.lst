C51 COMPILER V9.00   ROMTEST                                                               04/13/2019 14:32:10 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ROMTEST
OBJECT MODULE PLACED IN ..\HEX\romtest.obj
COMPILER INVOKED BY: c:\Keil\C51\BIN\C51.EXE ..\SCR\romtest.c BROWSE INCDIR(..\INC) DEBUG OBJECTEXTEND PRINT(.\romtest.l
                    -st) TABS(2) OBJECT(..\HEX\romtest.obj)

line level    source

   1          /****************************************************************************
   2          * File:     romtest.c                         *
   3          * Created:    2015-02-13                          *
   4          * Last Change:                                *
   5          * Author:   chen zhi peng                         *
   6          * Description:                                *
   7          ****************************************************************************/
   8          #include "ROMTEST.h"
   9          
  10          
  11          
  12          
  13          //********************************************************************************************************
             -****//
  14          ////存储器测试
  15          //********************************************************************************************************
             -****//
  16          void RomTest()
  17          {
  18   1        u8 t=0,i=0;
  19   1        u8 xdata buff[8];
  20   1        WDT_CONTR=DISABLE;    //内部看门狗关闭
  21   1        err=ERR_EEPROM_WRITE;
  22   1        EEPROM_read_n ( FIRST_SECTOR,&buff,8 );
  23   1        for ( t=0; t<8; t++ )
  24   1        {
  25   2          if ( buff[t]==eight )
  26   2          {
  27   3            i++;    //存储器识别码
  28   3          }
  29   2        }
  30   1        if ( i==8 )
  31   1        {
  32   2          err=ERR_INT;
  33   2        }
  34   1        if ( err==ERR_EEPROM_WRITE ) //系统初始化
  35   1        {
  36   2          //********擦&写&读3次测试X个扇区**********//
  37   2          for ( t=0; t<1; t++ )
  38   2          {
  39   3            SectotE ( FIRST_SECTOR,0x200,2 ); //删除x扇区
  40   3            delay ( 10 );
  41   3            SectotWT ( FIRST_SECTOR,0xaa,2 ); //x个扇区里全写满数据0xAA=10101010
  42   3            delay ( 10 );
  43   3            if ( SectotRT ( FIRST_SECTOR,0xaa,2 ) )
  44   3            {
  45   4              BUZZ=BUZZ_EN;     //读x个扇区并判断数据是否错误
  46   4            }
  47   3            delay ( 10 );
  48   3            SectotE ( FIRST_SECTOR,0x200,2 ); //删除x扇区
  49   3            delay ( 10 );
  50   3            SectotWT ( FIRST_SECTOR,0x55,2 ); //x个扇区里全写满数据0x55=01010101
  51   3            delay ( 10 );
  52   3            if ( SectotRT ( FIRST_SECTOR,0x55,2 ) )
C51 COMPILER V9.00   ROMTEST                                                               04/13/2019 14:32:10 PAGE 2   

  53   3            {
  54   4              BUZZ=BUZZ_EN;     //读x个扇区并判断数据是否错误
  55   4            }
  56   3            delay ( 10 );
  57   3          }
  58   2          //********测试完成，1扇区写入初始化识别数-8个识别码,用作识别是否已经初始化配置**********//
  59   2          if ( BUZZ )
  60   2          {
  61   3            EEPROM_SectorErase ( FIRST_SECTOR );
  62   3            for ( t=0; t<8; t++ )
  63   3            {
  64   4              buff[t]=eight;
  65   4            }
  66   3            EEPROM_write_n ( FIRST_SECTOR,&buff,8 );
  67   3          }
  68   2          else
  69   2          {
  70   3            BUZZ=BUZZ_CL;
  71   3            err=ERR_EEPROM_WRITE1;
  72   3          }
  73   2        }
  74   1      
  75   1      }
  76          
  77          
  78          
  79          
  80          
  81          //********************************************************************************************************
             -****
  82          ////SectotE扇区删除
  83          //入口变量 dx:扇区起始地址
  84          //       hf:扇区首地址间隔
  85          //       tt:删除扇区数量
  86          //
  87          //********************************************************************************************************
             -****
  88          void SectotE ( u16 dx, u16 hf, u8 tt )
  89          {
  90   1      
  91   1      
  92   1        u8 k;
  93   1        for ( k=0; k<tt; k++ )
  94   1        {
  95   2          LED=1;
  96   2          EEPROM_SectorErase ( dx );
  97   2          delay ( 10 );
  98   2          dx+=hf;
  99   2        }
 100   1      }
 101          
 102          //********************************************************************************************************
             -****
 103          ////SectotWT扇区写入测试
 104          //入口变量  dx:扇区起始地址
 105          //      nu:要写的数据
 106          //        tt:写操作扇区数量
 107          //********************************************************************************************************
             -****
 108          void SectotWT ( u16 dx, u8 nu, u8 tt )
 109          {
 110   1      
C51 COMPILER V9.00   ROMTEST                                                               04/13/2019 14:32:10 PAGE 3   

 111   1      
 112   1        u8 k,i;
 113   1        u8 xdata buff[8];
 114   1        for ( k=0; k<8; k++ )
 115   1        {
 116   2          buff[k]=nu;
 117   2        }
 118   1        for ( k=0; k<tt; k++ )
 119   1        {
 120   2          for ( i=0; i<64; i++ ) //一个扇区分64次写入，一次写8个字节
 121   2          {
 122   3            EEPROM_write_n ( dx,&buff,8 );
 123   3            dx+=8;
 124   3            delay ( 10 );
 125   3          }
 126   2          LED=!LED;
 127   2      
 128   2          delay ( 30 );
 129   2        }
 130   1      
 131   1      }
 132          
 133          
 134          //********************************************************************************************************
             -****
 135          ////SectotRT扇区读出测试
 136          //入口变量  dx:扇区起始地址
 137          //      nu:要比较的数据
 138          //        tt:读操作扇区数量
 139          //********************************************************************************************************
             -****
 140          bit SectotRT ( u16 dx, u8 nu, u8 tt )
 141          {
 142   1      
 143   1        u8 k,u,i;
 144   1        u8 xdata buff[8];
 145   1        u16 cnum=0;
 146   1      
 147   1        for ( k=0; k<tt; k++ )
 148   1        {
 149   2          for ( i=0; i<64; i++ )
 150   2          {
 151   3            EEPROM_read_n ( dx,&buff,8 );
 152   3            dx+=8;
 153   3            for ( u=0; u<8; u++ )
 154   3            {
 155   4              if ( buff[u]==nu )
 156   4              {
 157   5                cnum++;
 158   5              }
 159   4            }
 160   3            LED=!LED;
 161   3            delay ( 10 );
 162   3          }
 163   2          delay ( 30 );
 164   2        }
 165   1        if ( cnum< ( 512*tt-1 ) )
 166   1        {
 167   2          return 1;
 168   2        }
 169   1        else
 170   1        {
C51 COMPILER V9.00   ROMTEST                                                               04/13/2019 14:32:10 PAGE 4   

 171   2          return 0;
 172   2        }
 173   1        return 0;
 174   1      
 175   1      }
 176          
 177          
 178          
 179          
 180          
 181          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    557    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      24
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
